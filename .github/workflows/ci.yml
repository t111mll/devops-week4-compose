name: CI

on:
 push:
  branches: [ "main" ]
 pull_request:

jobs:
 lint:
  runs-on: ubuntu-latest
  steps:
   - name: Checkout repository
     uses: actions/checkout@v4
   - name: Validate Docker Compose file
     run: docker compose config

 build:
  runs-on: ubuntu-latest
  needs: lint
  environment: development

  steps:
   - name: Checkout repository
     uses: actions/checkout@v4
   - name: Build Docker image
     env:
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
     run: |
      echo "Secret injected successfully"
      docker build -t devops-week4-app .

 build-prod:
  runs-on: ubuntu-latest
  needs: lint
  environment: production

  steps:
   - name: Checkout repository
     uses: actions/checkout@v4
   - name: Build Docker image (prod)
     env:
      POSTGRES_PASSWORD: ${{ sercrets.POSTGRES_PASSWORD }}
     run: |
      echo "Building image for production"
      docker build -t devops-week4-app:prod .
